# Checkpoints

**Задание** `5.1`: Подготовка механизма статусов (`Custom Facts`) Мы не хотим удалять хост из инвентаря, чтобы выключить на него трафик. Мы будем помечать его специальным фактом:

- Создай новый `Play` для группы `appservers`.
- **Задача**: Создать на серверах папку `/etc/ansible/facts.d`.
- **Задача**: Загрузить туда файл `phoenix.fact` (формат `JSON` или `INI`).
  - Содержимое по умолчанию: `{"status": "active"}`.
  - Сделай так, чтобы ты мог переопределить это состояние через внешнюю переменную при запуске плейбука (например, `-e "target_state=drain"`), но если переменная не передана — оставалось текущее состояние или `active`.
- **Задача**: Перечитать факты (`setup` модуль), чтобы `Ansible` увидел новые данные в `ansible_local`.

```bash

```

Покажем в терминале:



**Задание** `5.2`: Шаблон-монстр (`Jinja2 Logic`) Переходим к `balancers`. Нам нужно заменить статичный конфиг `Nginx` на шаблон `nginx.conf.j2`:

- Найди секцию `upstream backend { ... }` в конфиге `Nginx`.
- Напиши цикл на `Jinja2`, который:
  - Перебирает всех хостов из группы `appservers`.
  - Условие (`Hard`): В конфиг попадают только те серверы, у которых в кастомных фактах (`ansible_local.phoenix.status`) значение равно `active`.
- Если статус `drain` или факт отсутствует — сервер в конфиг не пишется.
- Формат строки внутри блока: `server <IP_ADDRESS>:80`;
- **Нюанс**: `IP`-адрес нужно брать из `hostvars[item]['ansible_host']`.

```bash

```

Покажем в терминале:



**Задание** `5.3`: Защита от дурака (`Validate & Handlers`) Если ты ошибся в синтаксисе шаблона, `Nginx` упадет при рестарте. Это недопустимо:

- В таске `template` используй параметр `validate`.
  - Команда валидации: `nginx -t -c %s` (где `%s` — временный файл, который создает `Ansible`).
  - Если валидация не проходит, `Ansible` должен прервать выполнение и не перезаписывать реальный файл конфига.
- Используй `notify: Reload Nginx` для применения настроек. Рестарт (`stop/start`) не нужен, только `reload`.

```bash

```

Покажем в терминале:



**Задание** `5.4`: Проверка боем (Оркестрация) Теперь самое сложное — собрать всё в один сценарий обновления. Твой `site.yml` должен работать так:

- Сначала собирает факты с `appservers` (чтобы знать их статусы).
- Потом настраивает `balancers`, используя данные из пункта выше.

```bash

```

Покажем в терминале:


**Сценарий проверки** (`Action`):

1. Запусти плейбук. Убедись, что в `nginx.conf` на балансере прописан `IP` апп-сервера.
2. Измени статус апп-сервера на `drain`:
  - Либо через `Ad-Hoc`: `ansible appservers -m copy -a "content='{\"status\":\"drain\"}' dest=/etc/ansible/facts.d/phoenix.fact"`
  - Либо написав отдельный мини-плейбук для переключения режима.
3. Снова запусти основной `site.yml`.
4. **Результат**: `Ansible` должен увидеть изменение факта на апп-сервере, перегенерировать конфиг на балансере (убрав оттуда `IP`) и сделать `Reload Nginx`.

**Критерии приемки** (`Definition of Done`)

1. В шаблоне `nginx.conf.j2` используется цикл `{% for host in groups['appservers'] %}`.
2. Внутри цикла есть проверка `if hostvars[host]['ansible_local']['phoenix']['status'] == 'active'`.
3. Ты реализовал `Defensive Coding`: если `ansible_local` еще не создан на каком-то хосте, шаблон не падает с ошибкой `undefined variable`, а просто пропускает этот хост (используй `is defined` или `default`).
